<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BirdieBuzz Signup</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    @keyframes spinY { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }
    .spin-y { animation: spinY 1.5s linear infinite; transform-style: preserve-3d; }
    .header-font { font-family: 'Poppins', sans-serif; }
    .soft-edges {
      -webkit-mask-image:
        linear-gradient(to bottom,
          rgba(0,0,0,0) 0%,
          rgba(0,0,0,1) 1.5%,
          rgba(0,0,0,1) 98.5%,
          rgba(0,0,0,0) 100%
        ),
        linear-gradient(to right,
          rgba(0,0,0,0) 0%,
          rgba(0,0,0,1) 1%,
          rgba(0,0,0,1) 99%,
          rgba(0,0,0,0) 100%
        );
      mask-image:
        linear-gradient(to bottom,
          rgba(0,0,0,0) 0%,
          rgba(0,0,0,1) 1.5%,
          rgba(0,0,0,1) 98.5%,
          rgba(0,0,0,0) 100%
        ),
        linear-gradient(to right,
          rgba(0,0,0,0) 0%,
          rgba(0,0,0,1) 1%,
          rgba(0,0,0,1) 99%,
          rgba(0,0,0,0) 100%
        );
      -webkit-mask-composite: intersect;
      mask-composite: intersect;
    }
    .note-small { font-size: 0.85rem; font-style: italic; color: #065f46; margin-top: 0.25rem; margin-bottom: 1rem; }
    .error-message { color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; margin-bottom: 0.75rem; }
  </style>
</head>

<body class="bg-green-50 min-h-screen flex flex-col">
  <!-- Loader -->
  <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center space-y-4">
    <div style="perspective:1000px;">
      <img src="https://joeyswit.github.io/birdiebuzz/Logo3.png" alt="Loading" class="w-24 h-24 spin-y">
    </div>
    <p class="text-green-700 font-semibold text-lg">Loading...</p>
  </div>

  <div id="content" class="opacity-0 transition-opacity duration-700 ease-out">
    <!-- Header -->
    <header class="bg-green-100 py-5 px-4 flex justify-center sticky top-0 z-50 shadow-md">
      <div class="flex items-center justify-center gap-3 w-full max-w-md">
        <a href="https://birdiebuzzalerts.com">
          <img src="https://joeyswit.github.io/birdiebuzz/Logo3.png" alt="Bird Logo" class="h-14 md:h-20 w-auto">
        </a>
        <a href="https://birdiebuzzalerts.com">
          <img src="https://joeyswit.github.io/birdiebuzz/Text3.png" alt="BirdieBuzz" class="h-12 md:h-16 w-auto">
        </a>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-grow">
      <h2 class="text-2xl md:text-3xl font-semibold text-green-900 header-font text-center mt-10">Choose Your Option</h2>

      <!-- Form wrapper -->
      <div class="px-4 mt-6">
        <form id="subscriptionForm"
              class="bg-green-100 rounded-2xl shadow-xl p-6 max-w-lg mx-auto">
          <!-- Plan selection -->
          <fieldset class="mb-6">
            <legend class="text-lg font-semibold mb-3 text-green-900">Select Pricing Plan (one-time purchase)</legend>
            <label class="flex items-center mb-3 cursor-pointer" for="plan-2-day">
              <input type="radio" name="pricing" id="plan-2-day" value="2-day" class="mr-3" checked>
              <span><strong class="text-green-800">$2</strong> for 24 Hours, Single Golfer</span>
            </label>
            <label class="flex items-center mb-1 cursor-pointer" for="plan-5-full">
              <input type="radio" name="pricing" id="plan-5-full" value="5-full" class="mr-3">
              <span><strong class="text-green-800">$5</strong> for Full Tournament, Multiple Golfers</span>
            </label>
          </fieldset>

          <!-- Tournament URL -->
          <div class="mb-6">
            <label for="tournamentUrl" class="block mb-2 font-semibold text-green-900">Tournament URL</label>
            <input type="url" id="tournamentUrl" required placeholder="https://example.com/leaderboard"
                   autocomplete="url"
                   class="w-full p-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
            <div id="tournamentUrlError" class="error-message hidden" role="alert"></div>
          </div>

          <!-- Phone -->
          <div class="mb-6">
            <label for="phoneInput" class="block mb-2 font-semibold text-green-900">Phone Number</label>
            <input type="tel" id="phoneInput" pattern="\d{10}" required placeholder="e.g. 5551234567"
                   autocomplete="tel"
                   class="w-full p-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400">
            <div id="phoneHelp" class="note-small">Enter 10 digits only, no dashes or spaces.</div>
            <div id="phoneError" class="error-message hidden" role="alert"></div>
          </div>

          <!-- Single golfer -->
          <div id="singleGolferContainer" class="mb-6 hidden">
            <label for="singleGolferInput" class="block mb-2 font-semibold text-green-900">Golfer Name</label>
            <input type="text" id="singleGolferInput" placeholder="Golfer Name" required
                   class="w-full p-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400"
                   aria-describedby="singleGolferError">
            <div id="singleGolferError" class="error-message hidden" role="alert"></div>
            <div class="text-sm italic text-gray-700 mt-1">
              (Enter the name exactly as it appears on the leaderboard for alerts to work correctly.)
            </div>
          </div>

          <!-- Multi golfers -->
          <div id="multiGolfersContainer" class="mb-6 hidden">
            <label class="block mb-2 font-semibold text-green-900">Golfer Name(s)</label>
            <div id="golfersInputs" class="space-y-2"></div>
            <div class="text-sm italic text-gray-700 mt-2">
              (Enter the name exactly as it appears on the leaderboard for alerts to work correctly.)
            </div>
            <button type="button" id="addGolferBtn"
                    class="mt-2 bg-gray-200 text-gray-900 font-medium text-sm px-3 py-1 rounded disabled:opacity-50"
                    disabled>+ Add Golfer</button>
            <div id="maxGolfersNote" class="text-sm italic text-green-900 mt-2"></div>
          </div>

          <!-- Submit -->
          <button type="submit" id="submitBtn"
                  class="w-full bg-green-600 text-white font-semibold py-2 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center"
                  aria-live="polite" disabled>
            <span id="submitBtnText">Submit</span>
            <svg id="loadingSpinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
          </button>

          <!-- Consent (below submit) -->
          <div class="mt-8">
            <label class="flex items-start gap-2 text-sm text-gray-700">
              <input type="checkbox" id="consentCheckbox" class="mt-1">
              <span>
                By checking this box, you agree to receive SMS alerts from BirdieBuzz about golfers you follow.
                Message frequency varies (around 18 per day). Consent isnâ€™t a condition of purchase.
                Message &amp; data rates may apply. Reply STOP to cancel, HELP for help.
                See <a href="/terms/" class="text-green-700 underline">Terms</a> and
                <a href="/privacy/" class="text-green-700 underline">Privacy</a>.
              </span>
            </label>
            <div id="consentError" class="error-message hidden" role="alert"></div>
          </div>
        </form>

        <!-- Disclaimer (directly beneath the form) -->
        <p class="text-xs text-gray-600 italic max-w-lg mx-auto mt-3" role="note" aria-label="Disclaimer">
          Disclaimer: BirdieBuzz relies on public leaderboard data and live scoring entered on the course. Occasional delays, errors, or unsupported tournaments may affect accuracy. Use for informational purposes only.
        </p>
      </div>

      <!-- Screenshot -->
      <div class="px-4 mt-14 mb-10">
        <img src="PhoneScreenshot12.png" alt="BirdieBuzz SMS preview"
             class="soft-edges mx-auto w-full max-w-sm md:max-w-md lg:max-w-lg rounded-xl shadow-md">
      </div>
    </main>

    <footer class="bg-green-50 text-green-900 py-6 text-center text-sm">
      &copy; 2025 BirdieBuzz. All rights reserved.
    </footer>
  </div>

  <script>
    // DOM
    const form = document.getElementById('subscriptionForm');
    const phoneInput = document.getElementById('phoneInput');
    const phoneError = document.getElementById('phoneError');
    const tournamentUrlInput = document.getElementById('tournamentUrl');
    const tournamentUrlError = document.getElementById('tournamentUrlError');
    const golfersInputs = document.getElementById('golfersInputs');
    const addGolferBtn = document.getElementById('addGolferBtn');
    const maxGolfersNote = document.getElementById('maxGolfersNote');
    const submitBtn = document.getElementById('submitBtn');
    const submitBtnText = document.getElementById('submitBtnText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const singleGolferContainer = document.getElementById('singleGolferContainer');
    const singleGolferInput = document.getElementById('singleGolferInput');
    const singleGolferError = document.getElementById('singleGolferError');
    const multiGolfersContainer = document.getElementById('multiGolfersContainer');
    const consentCheckbox = document.getElementById('consentCheckbox');
    const consentError = document.getElementById('consentError');

    let golferCount = 0;
    const maxGolfers = 15;
    const stripe = Stripe("pk_live_51Pm1nxREcKOamW909Su4Z9ijrkqr6a3pnhPHZZk1ZH5FyUxjjbAP30PC7Uy7jZaxSZRKQxXwUKBjox7JeU5cc7Io00oeuVxi9V");

    // Helpers
    function showError(el, msg){ el.textContent = msg; el.classList.remove('hidden'); }
    function hideError(el){ el.textContent=''; el.classList.add('hidden'); }
    function validatePhone(){
      const v = phoneInput.value.trim();
      if(!v){ showError(phoneError,'Phone number is required.'); return false; }
      if(!/^\d{10}$/.test(v)){ showError(phoneError,'Phone number must be exactly 10 digits.'); return false; }
      hideError(phoneError); return true;
    }
    function validateTournamentUrl(){
      const url = tournamentUrlInput.value.trim();
      if(!url){ showError(tournamentUrlError,'Tournament URL is required.'); return false; }
      try{ new URL(url); } catch { showError(tournamentUrlError,'Please enter a valid URL.'); return false; }
      hideError(tournamentUrlError); return true;
    }
    function validateGolfers(){
      const plan = form.pricing.value;
      if(plan === '5-full'){
        let valid = true;
        for(const input of golfersInputs.querySelectorAll('input[name="golferNames[]"]')){
          const err = input.closest('div')?.querySelector('.error-message');
          if(!input.value.trim()){ showError(err,'Golfer name is required.'); valid=false; } else hideError(err);
        }
        return valid;
      } else {
        if(!singleGolferInput.value.trim()){ showError(singleGolferError,'Golfer name is required.'); return false; }
        hideError(singleGolferError); return true;
      }
    }
    function validateConsent(){
      if(!consentCheckbox.checked){ showError(consentError,'You must agree to receive SMS alerts.'); return false; }
      hideError(consentError); return true;
    }
    function isFormValid(){ return validatePhone() && validateTournamentUrl() && validateGolfers() && validateConsent(); }

    // UI logic
    function updateAddGolferBtnState(){
      if(golferCount >= maxGolfers){ addGolferBtn.disabled = true; return; }
      const last = [...golfersInputs.querySelectorAll('input[name="golferNames[]"]')].pop();
      addGolferBtn.disabled = !last || !last.value.trim();
    }
    function clearGolfers(){ golfersInputs.innerHTML=''; golferCount=0; addGolferBtn.disabled=false; maxGolfersNote.textContent=''; }
    function addGolfer(){
      if(golferCount >= maxGolfers) return;
      golferCount++;
      const div = document.createElement('div');
      div.className = 'flex items-center space-x-2';
      const input = document.createElement('input');
      input.type='text'; input.name='golferNames[]';
      input.placeholder=`Golfer ${golferCount} Name`;
      input.className='flex-grow p-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400';
      input.required = true;
      const errorMsg = document.createElement('div'); errorMsg.className='error-message hidden';
      div.appendChild(input);
      if(golferCount>1){
        const removeBtn=document.createElement('button');
        removeBtn.type='button'; removeBtn.textContent='Remove';
        removeBtn.className='text-red-600 hover:underline text-sm';
        removeBtn.onclick=()=>{ div.remove(); golferCount--; updateAddGolferBtnState(); };
        div.appendChild(removeBtn);
      }
      div.appendChild(errorMsg);
      golfersInputs.appendChild(div);
      updateAddGolferBtnState();
    }
    function updateGolfersVisibility(){
      const plan = form.pricing.value;
      if(plan === '5-full'){
        if(singleGolferInput.value.trim()){
          clearGolfers(); addGolfer();
          golfersInputs.querySelector('input[name="golferNames[]"]').value = singleGolferInput.value.trim();
        } else if(golferCount===0){ addGolfer(); }
        multiGolfersContainer.classList.remove('hidden');
        singleGolferContainer.classList.add('hidden');
        updateAddGolferBtnState();
      } else {
        const firstMulti = golfersInputs.querySelector('input[name="golferNames[]"]');
        if(firstMulti && firstMulti.value.trim()){ singleGolferInput.value = firstMulti.value.trim(); }
        singleGolferContainer.classList.remove('hidden');
        multiGolfersContainer.classList.add('hidden');
        clearGolfers(); addGolferBtn.disabled = true;
      }
    }

    // Consent gates submit
    function gateSubmit(){ submitBtn.disabled = !consentCheckbox.checked; }

    // Events
    addGolferBtn.addEventListener('click', addGolfer);
    golfersInputs.addEventListener('input', updateAddGolferBtnState);
    form.querySelectorAll('input[name="pricing"]').forEach(r => r.addEventListener('change', updateGolfersVisibility));
    consentCheckbox.addEventListener('change', ()=>{ hideError(consentError); gateSubmit(); });

    form.addEventListener('submit', async e => {
      e.preventDefault();
      if(!isFormValid()) return;

      // lock UI
      [...form.elements].forEach(el=>el.disabled=true);
      loadingSpinner.classList.remove('hidden'); submitBtnText.textContent='Loading...';

      const pricing = form.pricing.value;
      const phone = phoneInput.value.trim();
      const tournamentUrl = tournamentUrlInput.value.trim();
      const golfers = (pricing === '5-full')
        ? [...golfersInputs.querySelectorAll('input[name="golferNames[]"]')].map(i=>i.value.trim())
        : [singleGolferInput.value.trim()];
      const consent = consentCheckbox.checked;
      const consentTs = new Date().toISOString();

      fetch("https://birdiebuzz-signup.joeyswit.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pricing, phone, tournamentUrl, golferNames: golfers, consent, consentTs })
      })
      .then(r=>r.json())
      .then(d=>{
        if(!d.sessionId) throw new Error("No sessionId returned");
        return stripe.redirectToCheckout({ sessionId: d.sessionId });
      })
      .catch(err=>{
        alert("Error: " + err.message);
        [...form.elements].forEach(el=>el.disabled=false);
        loadingSpinner.classList.add('hidden'); submitBtnText.textContent='Submit';
        gateSubmit(); // keep gating on consent
      });
    });

    // Init
    updateGolfersVisibility();
    gateSubmit();

    window.addEventListener('load', ()=>{
      setTimeout(()=>{
        document.getElementById('loader').style.display='none';
        document.getElementById('content').classList.remove('opacity-0');
      }, 800);
    });
  </script>
</body>
</html>
